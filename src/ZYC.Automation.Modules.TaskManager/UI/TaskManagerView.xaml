<page:PageBase x:Class="ZYC.Automation.Modules.TaskManager.UI.TaskManagerView"
               x:ClassModifier="internal"
               xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
               xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
               xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
               xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
               xmlns:page="clr-namespace:ZYC.Automation.Core.Page;assembly=ZYC.Automation.Core"
               xmlns:localizations="clr-namespace:ZYC.Automation.Core.Localizations;assembly=ZYC.Automation.Core"
               xmlns:bindings="clr-namespace:ZYC.Automation.Core.Bindings;assembly=ZYC.Automation.Core"
               xmlns:converters="clr-namespace:ZYC.Automation.Core.Converters;assembly=ZYC.Automation.Core"
               xmlns:wpf="clr-namespace:Emoji.Wpf;assembly=Emoji.Wpf"
               xmlns:markupEx="clr-namespace:ZYC.Automation.Core.MarkupEx;assembly=ZYC.Automation.Core"
               xmlns:commands="clr-namespace:ZYC.Automation.Modules.TaskManager.Commands"
               xmlns:core="clr-namespace:ZYC.Automation.Core;assembly=ZYC.Automation.Core"
               xmlns:localConverters="clr-namespace:ZYC.Automation.Modules.TaskManager.Converters"
               xmlns:local="clr-namespace:ZYC.Automation.Modules.TaskManager.Abstractions;assembly=ZYC.Automation.Modules.TaskManager.Abstractions"
               xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
               xmlns:buttons="clr-namespace:ZYC.Automation.Core.Buttons;assembly=ZYC.Automation.Core"
               mc:Ignorable="d"
               d:DesignHeight="450" d:DesignWidth="800"
               Loaded="OnTaskManagerViewLoaded"
               Title="{localizations:L TaskManager}"
               DataContext="{Binding RelativeSource={RelativeSource Self}}">
    <page:PageBase.HeaderAdditionContent>
        <StackPanel VerticalAlignment="Center"
                    HorizontalAlignment="Right"
                    Orientation="Horizontal">
            <ComboBox Width="128"
                      ItemsSource="{markupEx:EnumBindingSource {x:Type local:FilterType}}"
                      Margin="16 0 0 0"
                      Height="24"
                      SelectedItem="{Binding FilterType,Mode=TwoWay}">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <wpf:TextBlock Text="{bindings:LBinding .}"
                                       Margin="8 0 0 0"
                                       VerticalAlignment="Center" />
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>
            <TextBox Text="{Binding FilterText,UpdateSourceTrigger=PropertyChanged}"
                     mah:TextBoxHelper.Watermark="{localizations:L Search task}"
                     Width="256"
                     Height="24"
                     Margin="16 0 0 0"
                     Style="{DynamicResource MahApps.Styles.TextBox.Search}" />

        </StackPanel>
    </page:PageBase.HeaderAdditionContent>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition />
        </Grid.RowDefinitions>
        <StackPanel Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Margin="0 8 0 0">
            <buttons:IconButton
                Kind="TrashCanOutline"
                Text="{localizations:L Clean up tasks}"
                Command="{markupEx:LifetimeScopeResolve commands:ClearUpTasksCommand}" />
        </StackPanel>
        <Border Grid.Row="1">
            <ScrollViewer>
                <ItemsControl
                    Margin="0 8 0 0"
                    ItemsSource="{Binding ManagedTasksCollectionView}"
                    ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                    ScrollViewer.VerticalScrollBarVisibility="Auto"
                    SnapsToDevicePixels="True">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Margin" Value="0 0 12 12" />
                        </Style>
                    </ItemsControl.ItemContainerStyle>

                    <ItemsControl.Resources>
                        <Style x:Key="ChipBorderStyle" TargetType="Border">
                            <Setter Property="CornerRadius" Value="10" />
                            <Setter Property="Padding" Value="8 3" />
                            <Setter Property="Margin" Value="0 0 8 8" />
                            <Setter Property="BorderThickness" Value="1" />
                            <Setter Property="Background"
                                    Value="{DynamicResource {x:Static SystemColors.ControlLightBrushKey}}" />
                            <Setter Property="BorderBrush"
                                    Value="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}" />
                        </Style>

                        <Style x:Key="ChipTextStyle" TargetType="TextBlock">
                            <Setter Property="FontSize" Value="11" />
                            <Setter Property="Opacity" Value="0.85" />
                            <Setter Property="VerticalAlignment" Value="Center" />
                        </Style>

                        <Style x:Key="ActionButtonStyle" TargetType="Button">
                            <Setter Property="Width" Value="34" />
                            <Setter Property="Height" Value="34" />
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="Margin" Value="0 0 6 0" />
                            <Setter Property="Background" Value="Transparent" />
                            <Setter Property="BorderBrush" Value="Transparent" />
                            <Setter Property="BorderThickness" Value="0" />
                        </Style>
                    </ItemsControl.Resources>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Width="440"
                                    MinHeight="130"
                                    Padding="12"
                                    CornerRadius="10"
                                    BorderThickness="1"
                                    Background="{DynamicResource {x:Static SystemColors.WindowBrushKey}}"
                                    BorderBrush="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <Grid Grid.Column="0">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        <Grid Grid.Row="0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Grid.Column="0"
                                                       FontSize="14"
                                                       FontWeight="SemiBold"
                                                       Text="{Binding DefinitionId}"
                                                       TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center" />
                                            <Border Grid.Column="1"
                                                    Padding="8 3"
                                                    CornerRadius="10"
                                                    Margin="10 0 0 0"
                                                    VerticalAlignment="Center">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Background"
                                                                Value="{DynamicResource {x:Static SystemColors.ControlLightBrushKey}}" />
                                                        <Setter Property="BorderBrush"
                                                                Value="{DynamicResource {x:Static SystemColors.ControlDarkBrushKey}}" />
                                                        <Setter Property="BorderThickness" Value="1" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding State}"
                                                                         Value="{x:Static local:ManagedTaskState.Running}">
                                                                <Setter Property="Background" Value="#E6F6EE" />
                                                                <Setter Property="BorderBrush" Value="#7ACB9A" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding State}"
                                                                         Value="{x:Static local:ManagedTaskState.Paused}">
                                                                <Setter Property="Background" Value="#FFF4E5" />
                                                                <Setter Property="BorderBrush" Value="#F0B35A" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding State}"
                                                                         Value="{x:Static local:ManagedTaskState.Faulted}">
                                                                <Setter Property="Background" Value="#FDEAEA" />
                                                                <Setter Property="BorderBrush" Value="#E07A7A" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding State}"
                                                                         Value="{x:Static local:ManagedTaskState.Canceled}">
                                                                <Setter Property="Background" Value="#F1F1F1" />
                                                                <Setter Property="BorderBrush" Value="#BDBDBD" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding State}"
                                                                         Value="{x:Static local:ManagedTaskState.Completed}">
                                                                <Setter Property="Background" Value="#E8F7EF" />
                                                                <Setter Property="BorderBrush" Value="#4CAF72" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>

                                                <TextBlock FontSize="12"
                                                           FontWeight="SemiBold"
                                                           Text="{Binding State}" />
                                            </Border>
                                        </Grid>

                                        <Grid Grid.Row="1"
                                              Margin="0 8 0 0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <ProgressBar Height="8"
                                                         Maximum="1"
                                                         VerticalAlignment="Center">
                                                <ProgressBar.Value>
                                                    <MultiBinding
                                                        Converter="{localConverters:ProgressMultiValueConverter}">
                                                        <Binding Path="Progress" Mode="OneWay" />
                                                        <Binding Path="State" Mode="OneWay" />
                                                    </MultiBinding>
                                                </ProgressBar.Value>
                                            </ProgressBar>

                                            <TextBlock Grid.Column="1"
                                                       Margin="10 0 0 0"
                                                       FontSize="12"
                                                       Opacity="0.85"
                                                       VerticalAlignment="Center">
                                                <TextBlock.Text>
                                                    <MultiBinding
                                                        Converter="{localConverters:ProgressMultiValueConverter}"
                                                        StringFormat="{}{0:P1}">
                                                        <Binding Path="Progress" Mode="OneWay" />
                                                        <Binding Path="State" Mode="OneWay" />
                                                    </MultiBinding>
                                                </TextBlock.Text>
                                            </TextBlock>
                                        </Grid>


                                        <TextBlock Grid.Row="2"
                                                   Margin="0 8 0 0"
                                                   Text="{Binding StatusText}"
                                                   TextWrapping="Wrap"
                                                   TextTrimming="CharacterEllipsis"
                                                   Opacity="0.9" />
                                        <TextBlock Grid.Row="3"
                                                   Margin="0 6 0 0"
                                                   Text="{Binding FaultText}"
                                                   TextWrapping="Wrap"
                                                   TextTrimming="CharacterEllipsis"
                                                   Foreground="#C0392B">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Visible" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding FaultText}" Value="{x:Null}">
                                                            <Setter Property="Visibility" Value="Collapsed" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>

                                        <WrapPanel Grid.Row="4" Margin="0 10 0 0">
                                            <Border Style="{StaticResource ChipBorderStyle}">
                                                <TextBlock Style="{StaticResource ChipTextStyle}">
                                                    <Run Text="Provider: " />
                                                    <Run Text="{Binding ProviderId,Mode=OneWay}" />
                                                </TextBlock>
                                            </Border>

                                            <Border Style="{StaticResource ChipBorderStyle}">
                                                <TextBlock Style="{StaticResource ChipTextStyle}">
                                                    <Run Text="Version: v" />
                                                    <Run Text="{Binding DefinitionVersion,Mode=OneWay}" />
                                                </TextBlock>
                                            </Border>

                                            <Border Style="{StaticResource ChipBorderStyle}">
                                                <TextBlock Style="{StaticResource ChipTextStyle}"
                                                           Text="{Binding CreatedAt, StringFormat=Created: {0:MM-dd HH:mm}}" />
                                            </Border>

                                            <Border Style="{StaticResource ChipBorderStyle}">
                                                <TextBlock Style="{StaticResource ChipTextStyle}">
                                                    <Run Text="PauseKind: " />
                                                    <Run Text="{Binding PauseKind,Mode=OneWay}" />
                                                </TextBlock>
                                            </Border>
                                        </WrapPanel>
                                    </Grid>

                                    <StackPanel Grid.Column="1"
                                                Margin="14 0 0 0"
                                                VerticalAlignment="Top"
                                                Orientation="Horizontal">
                                        <Button Style="{StaticResource ActionButtonStyle}"
                                                Command="{markupEx:LifetimeScopeResolve commands:ResumeCommand}"
                                                CommandParameter="{Binding Id}"
                                                ToolTip="Resume">
                                            <core:HybridIcon Width="18" Height="18" Icon="PlayCircleOutline" />
                                        </Button>

                                        <Button Style="{StaticResource ActionButtonStyle}"
                                                Command="{markupEx:LifetimeScopeResolve commands:PauseCommand}"
                                                CommandParameter="{Binding Id}"
                                                ToolTip="Pause">
                                            <core:HybridIcon Width="18" Height="18" Icon="PauseCircleOutline" />
                                        </Button>

                                        <Button Style="{StaticResource ActionButtonStyle}"
                                                Command="{markupEx:LifetimeScopeResolve commands:CancelCommand}"
                                                CommandParameter="{Binding Id}"
                                                ToolTip="Cancel"
                                                Margin="0">
                                            <core:HybridIcon Width="18" Height="18" Icon="CloseCircleOutline" />
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>


            </ScrollViewer>

        </Border>
        <!--!WARNING Binding ElementName directly to ItemControl's Items.Count seems reasonable here. However, on the first launch, when loading in the background, the binding will fail due to the visual tree loading order.-->
        <page:NoItemView Grid.Row="1"
                         Visibility="{Binding CollectionViewCount,Converter={converters:IntToVisibilityConverter Reverse=True},FallbackValue=Collapsed}" />
    </Grid>
</page:PageBase>