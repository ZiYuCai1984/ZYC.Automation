<UserControl x:Class="ZYC.Automation.MainMenu.MenuButtonView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:converters="clr-namespace:ZYC.Automation.Core.Converters;assembly=ZYC.Automation.Core"
             xmlns:mainMenu="clr-namespace:ZYC.Automation.Abstractions.MainMenu;assembly=ZYC.Automation.Abstractions"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800"
             Visibility="{Binding MainMenuConfig.IsVisible,Converter={converters:BoolToVisibilityConverter}}"
             Loaded="OnMenuButtonViewLoaded"
             Background="{DynamicResource MahApps.Brushes.Validation2}"
             DataContext="{Binding RelativeSource={RelativeSource Self}}">
    <UserControl.Resources>
        <ResourceDictionary Source="/Styles/MainMenu.xaml" />
    </UserControl.Resources>
    <Menu AllowDrop="True"
          VerticalAlignment="Center"
          Background="Transparent">
        <MenuItem Background="Transparent"
                  ItemsSource="{Binding MainMenuItems}">
            <MenuItem.Header>
                <iconPacks:PackIconMaterial Kind="Menu"
                                            HorizontalAlignment="Center"
                                            VerticalAlignment="Center"
                                            Width="16"
                                            Height="16" />
            </MenuItem.Header>
            <MenuItem.ItemContainerStyle>
                <Style BasedOn="{StaticResource MahApps.Styles.MenuItem}"
                       TargetType="MenuItem">
                    <Setter Property="ItemsSource" Value="{Binding SubItems}" />
                    <Setter Property="Command"
                            Value="{Binding Command}" />
                    <Setter Property="Header">
                        <Setter.Value>
                            <MultiBinding Converter="{converters:LocalizationMultiConverter}">
                                <Binding Path="Title" />
                                <Binding Path="Localization" />
                            </MultiBinding>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="VirtualizingStackPanel.IsVirtualizing" Value="False" />
                    <!--!WARNING There is a suspected virtualization problem here. If it is set in the DataTemplate, it will not load normally.-->
                    <!--!WARNING Explicitly specify the Binding Path !! -->
                    <Setter Property="Icon"
                            Value="{Binding Path=(mainMenu:IMainMenuItem.Icon),Converter={converters:PackIconMaterialConverter}}" />
                    <Style.Triggers>
                        <Trigger Property="Role" Value="TopLevelHeader">
                            <Setter Property="Padding" Value="7 5 8 6" />
                            <Setter Property="Template"
                                    Value="{DynamicResource {ComponentResourceKey ResourceId=TopLevelHeaderTemplateKey, TypeInTargetAssembly={x:Type MenuItem}}}" />
                        </Trigger>
                        <Trigger Property="Role" Value="TopLevelItem">
                            <Setter Property="Padding" Value="7 5 8 6" />
                            <Setter Property="Template"
                                    Value="{DynamicResource {ComponentResourceKey ResourceId=TopLevelItemTemplateKey, TypeInTargetAssembly={x:Type MenuItem}}}" />
                        </Trigger>
                        <Trigger Property="Role" Value="SubmenuHeader">
                            <Setter Property="Padding" Value="2 6 2 6" />
                            <Setter Property="Template"
                                    Value="{DynamicResource {ComponentResourceKey ResourceId=SubmenuHeaderTemplateKey, TypeInTargetAssembly={x:Type MenuItem}}}" />
                        </Trigger>
                        <Trigger Property="Role" Value="SubmenuItem">
                            <Setter Property="Padding" Value="2 6 2 6" />
                            <Setter Property="Template"
                                    Value="{DynamicResource {ComponentResourceKey ResourceId=SubmenuItemTemplateKey, TypeInTargetAssembly={x:Type MenuItem}}}" />
                        </Trigger>
                        <DataTrigger Binding="{Binding}" Value="{x:Null}">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="MenuItem">
                                        <Separator />
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </MenuItem.ItemContainerStyle>
        </MenuItem>
    </Menu>
</UserControl>