using System.Reactive.Disposables;
using System.Reactive.Disposables.Fluent;
using ZYC.Automation.Abstractions;
using ZYC.Automation.Abstractions.Event;
using ZYC.Automation.Abstractions.State;
using ZYC.CoreToolkit;
using ZYC.CoreToolkit.Extensions.Autofac.Attributes;

namespace ZYC.Automation.Core.Commands;

[RegisterSingleInstance]
public class RestartCommand : CommandBase, IDisposable
{
    public RestartCommand(
        IAppContext appContext,
        IEventAggregator eventAggregator,
        IAppLogger<RestartCommand> logger,
        DesktopWindowState desktopWindowState)
    {
        AppContext = appContext;
        Logger = logger;
        DesktopWindowState = desktopWindowState;

        eventAggregator.Subscribe<SetPreventExitCommandExecutedEvent>(OnSetPreventExitCommandExecuted)
            .DisposeWith(CompositeDisposable);
    }


    private CompositeDisposable CompositeDisposable { get; } = new();

    protected virtual bool IsAdministrator => false;

    private IAppContext AppContext { get; }

    private IAppLogger<RestartCommand> Logger { get; }

    private DesktopWindowState DesktopWindowState { get; }

    public void Dispose()
    {
        CompositeDisposable.Dispose();
    }

    private void OnSetPreventExitCommandExecuted(SetPreventExitCommandExecutedEvent obj)
    {
        RaiseCanExecuteChanged();
    }


    public override bool CanExecute(object? parameter)
    {
        return !DesktopWindowState.IsPreventExit;
    }

    protected override void InternalExecute(object? parameter)
    {
        try
        {
            var fileName = AppContext.GetProcessFileName();
            var argumentString = AppContext.GetArgumentString();

            ProcessTools.Start(fileName, argumentString, IsAdministrator);

            //!WARNING Must save the configuration first and then try to restart
            AppContext.SaveAllConfig();
            AppContext.SaveAllState();

            AppContext.FocusExitProcess();
        }
        catch (Exception e)
        {
            Logger.Error(e);
        }
    }
}